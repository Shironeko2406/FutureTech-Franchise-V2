import React, { useState, useEffect } from 'react';
import { Steps, Divider, Typography, message, Spin } from 'antd';
import { CalendarOutlined, UserOutlined } from '@ant-design/icons';
import moment from 'moment';
import { useDispatch, useSelector } from 'react-redux';
import { useLocation } from 'react-router-dom';
import { GetClassesForStudentByAgencyIdActionAsync } from '../../../Redux/ReducerAPI/ClassReducer';
// import { RegisterCourseActionAsync } from "../../../Redux/ReducerAPI/RegisterCourseReducer";
import * as S from './RegisCourseStudentStyles';
import { RegisterCourseStudentActionAsync } from '../../../Redux/ReducerAPI/UserReducer';

const { Title, Text, Paragraph } = Typography;
const { Step } = Steps;

const translateDayOfWeek = (dayOfWeekString) => {
    const dayTranslation = {
        Monday: "Th·ª© Hai",
        Tuesday: "Th·ª© Ba",
        Wednesday: "Th·ª© T∆∞",
        Thursday: "Th·ª© NƒÉm",
        Friday: "Th·ª© S√°u",
        Saturday: "Th·ª© B·∫£y",
        Sunday: "Ch·ªß Nh·∫≠t",
    };

    return dayOfWeekString.split(/, ?/).map(day => dayTranslation[day.trim()] || day.trim()).join(", ");
};

const timeSlots = [
    { id: 'morning', label: 'S√°ng', time: '07:00 - 12:00', icon: 'üåÖ' },
    { id: 'afternoon', label: 'Chi·ªÅu', time: '13:00 - 18:00', icon: 'üå§Ô∏è' },
    { id: 'evening', label: 'T·ªëi', time: '18:00 - 21:00', icon: 'üåô' }
];

const RegisCourseStudent = () => {
    const location = useLocation();
    const registrationData = location.state?.registrationData;
    console.log('registrationData:', registrationData);
    const [selectedDays, setSelectedDays] = useState([]);
    const [selectedTime, setSelectedTime] = useState("");
    const [selectedSlot, setSelectedSlot] = useState("");
    const [selectedClass, setSelectedClass] = useState(null);
    const [isLoading, setIsLoading] = useState(false);
    const dispatch = useDispatch();
    const { classes } = useSelector((state) => state.ClassReducer);

    useEffect(() => {
        if (registrationData) {
            dispatch(GetClassesForStudentByAgencyIdActionAsync(registrationData.courseId, registrationData.agencyId));
        } else {
            message.error('No registration data found');
        }
    }, [dispatch, registrationData]);

    const filteredClasses = classes.filter(classItem => {
        const classDays = classItem.dayOfWeek.split(/, ?/).map(day => translateDayOfWeek(day.trim()));
        const selectedDaysMatch = selectedDays.some(day => classDays.includes(day));

        const classStartTime = moment(classItem.slotStart, 'HH:mm:ss');
        const classEndTime = moment(classItem.slotEnd, 'HH:mm:ss');
        const selectedTimeSlot = timeSlots.find(slot => slot.id === selectedTime);
        if (!selectedTimeSlot) return false;
        const selectedStartTime = moment(selectedTimeSlot.time.split(' - ')[0], 'HH:mm');
        const selectedEndTime = moment(selectedTimeSlot.time.split(' - ')[1], 'HH:mm');

        const timeMatch = classStartTime.isBefore(selectedEndTime) && classEndTime.isAfter(selectedStartTime);

        return selectedDaysMatch && timeMatch;
    });

    const handleSubmit = async () => {
        if (selectedClass) {
            setIsLoading(true);
            const response = await dispatch(RegisterCourseStudentActionAsync(selectedClass.id));
            setIsLoading(false);
            if (response.isSuccess && response.data) {
                window.location.href = response.data;
            } else {
                message.error('Registration failed');
            }
        } else {
            message.error('Vui l√≤ng ch·ªçn m·ªôt l·ªõp h·ªçc tr∆∞·ªõc khi ƒëƒÉng k√Ω.');
        }
    };

    return (
        <S.ScheduleContainer>
            <S.ScheduleWrapper>
                <S.ScheduleCard>
                    <Steps current={1} style={{ marginBottom: '2rem' }}>
                        <Step title="Ch·ªçn kh√≥a h·ªçc" />
                        <Step title="Ch·ªçn l·ªãch h·ªçc" />
                        <Step title="Thanh to√°n" />
                    </Steps>

                    <S.ScheduleTitle>L·ªãch H·ªçc</S.ScheduleTitle>
                    <S.ScheduleSubtitle>{registrationData?.courseName}</S.ScheduleSubtitle>

                    <Divider />

                    <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                        <div>
                            <S.SectionTitle>1. Ch·ªçn th·ªùi gian h·ªçc</S.SectionTitle>

                            <div style={{ marginBottom: '2rem' }}>
                                <Text strong style={{ fontSize: '1rem', marginBottom: '1rem', display: 'block', color: '#4b5563' }}>
                                    Ng√†y h·ªçc trong tu·∫ßn
                                </Text>
                                <S.DaySelector>
                                    {['Th·ª© Hai', 'Th·ª© Ba', 'Th·ª© T∆∞', 'Th·ª© NƒÉm', 'Th·ª© S√°u', 'Th·ª© B·∫£y', 'Ch·ªß Nh·∫≠t'].map((day) => (
                                        <S.DayButton
                                            key={day}
                                            type={selectedDays.includes(day) ? 'primary' : 'default'}
                                            onClick={() => setSelectedDays(prev =>
                                                prev.includes(day) ? prev.filter(d => d !== day) : [...prev, day]
                                            )}
                                        >
                                            {day}
                                        </S.DayButton>
                                    ))}
                                </S.DaySelector>
                            </div>

                            <div style={{ marginTop: '2rem' }}>
                                <Text strong style={{ fontSize: '1rem', marginBottom: '1rem', display: 'block', color: '#4b5563' }}>
                                    Th·ªùi gian h·ªçc
                                </Text>
                                <S.TimeSlotContainer>
                                    {timeSlots.map(slot => (
                                        <S.TimeSlot
                                            key={slot.id}
                                            as={selectedTime === slot.id ? S.TimeSlotSelected : S.TimeSlot}
                                            onClick={() => setSelectedTime(slot.id)}
                                        >
                                            <S.TimeSlotIcon>{slot.icon}</S.TimeSlotIcon>
                                            <S.TimeSlotContent>
                                                <S.TimeSlotTitle>{slot.label}</S.TimeSlotTitle>
                                                <S.TimeSlotTime>{slot.time}</S.TimeSlotTime>
                                            </S.TimeSlotContent>
                                        </S.TimeSlot>
                                    ))}
                                </S.TimeSlotContainer>
                            </div>
                        </div>

                        {selectedDays.length > 0 && selectedTime && (
                            <>
                                <Divider />
                                <div>
                                    <S.SectionTitle style={{ marginBottom: '2rem' }}>2. Ch·ªçn l·ªõp h·ªçc ph√π h·ª£p</S.SectionTitle>

                                    {filteredClasses.length > 0 ? (
                                        filteredClasses.map(classItem => (
                                            <S.ClassCard key={classItem.id}>
                                                <S.ClassHeader>
                                                    <CalendarOutlined style={{ fontSize: '24px', color: '#3b82f6' }} />
                                                    <S.ClassInfo>
                                                        <S.ClassSchedule>
                                                            {translateDayOfWeek(classItem.dayOfWeek)}
                                                            <S.ClassTimeTag>{classItem.slotStart} - {classItem.slotEnd}</S.ClassTimeTag>
                                                        </S.ClassSchedule>
                                                        <S.ClassDetails>
                                                            <S.ClassDetail>
                                                                <CalendarOutlined /> B·∫Øt ƒë·∫ßu: {moment(classItem.startDate).format('DD/MM/YYYY')}
                                                            </S.ClassDetail>
                                                            <S.ClassDetail>
                                                                <UserOutlined /> Gi·∫£ng vi√™n: {classItem.instructorName}
                                                            </S.ClassDetail>
                                                        </S.ClassDetails>
                                                    </S.ClassInfo>
                                                    <S.DayButton
                                                        type={selectedClass?.id === classItem.id ? 'primary' : 'default'}
                                                        onClick={() => setSelectedClass(classItem)}
                                                    >
                                                        {selectedClass?.id === classItem.id ? 'ƒê√£ ch·ªçn' : 'Ch·ªçn l·ªõp n√†y'}
                                                    </S.DayButton>
                                                </S.ClassHeader>

                                                <S.ProgressSection>
                                                    <div>
                                                        <S.ProgressTitle>Sƒ© s·ªë l·ªõp h·ªçc</S.ProgressTitle>
                                                        <S.StyledProgress
                                                            percent={(classItem.currentEnrollment / classItem.capacity) * 100}
                                                            format={() => `${classItem.currentEnrollment}/${classItem.capacity}`}
                                                        />
                                                    </div>
                                                    <div>
                                                        <S.ProgressTitle>Ti·∫øn ƒë·ªô kh√≥a h·ªçc</S.ProgressTitle>
                                                        <S.StyledProgress
                                                            percent={(classItem.daysElapsed / classItem.totalLessons) * 100}
                                                            format={() => `${classItem.daysElapsed}/${classItem.totalLessons}`}
                                                        />
                                                    </div>
                                                </S.ProgressSection>
                                            </S.ClassCard>
                                        ))
                                    ) : (
                                        <Text>Kh√¥ng c√≥ l·ªõp h·ªçc n√†o ph√π h·ª£p v·ªõi l·ª±a ch·ªçn c·ªßa b·∫°n.</Text>
                                    )}
                                </div>
                            </>
                        )}

                        {selectedClass && (
                            <>
                                <Divider />
                                <div style={{ marginBottom: '1rem' }}>
                                    <S.SectionTitle style={{ marginBottom: '2rem' }}>3. X√°c nh·∫≠n ƒëƒÉng k√Ω</S.SectionTitle>
                                    <S.ConfirmationCard>
                                        <Paragraph>
                                            Th√¥ng tin ƒëƒÉng k√Ω:
                                            <br />T√™n: <Text strong>{registrationData?.studentName}</Text>
                                            <br />S·ªë ƒëi·ªán tho·∫°i: <Text strong>{registrationData?.phoneNumber}</Text>
                                            <br />Email: <Text strong>{registrationData?.email}</Text>
                                            <br />Kh√≥a h·ªçc: <Text strong>{registrationData?.courseName}</Text>
                                            {/* <br />ƒê·ªãa ch·ªâ trung t√¢m: <Text strong>{registrationData?.agencyFullAddress}</Text> */}
                                            <br />L·ªãch h·ªçc: <Text strong>{`${translateDayOfWeek(selectedClass.dayOfWeek)} - ${selectedClass.slotStart} ƒë·∫øn ${selectedClass.slotEnd}`}</Text>
                                            <br />Ng√†y b·∫Øt ƒë·∫ßu: <Text strong>{moment(selectedClass.startDate).format('DD/MM/YYYY')}</Text>
                                        </Paragraph>
                                    </S.ConfirmationCard>
                                    <Spin spinning={isLoading}>
                                        <S.SubmitButton type="primary" size="large" onClick={handleSubmit} disabled={isLoading}>
                                            ƒêƒÉng k√Ω v√† thanh to√°n
                                        </S.SubmitButton>
                                    </Spin>
                                </div>
                            </>
                        )}
                    </div>
                </S.ScheduleCard>
            </S.ScheduleWrapper>
        </S.ScheduleContainer>
    );
};

export default RegisCourseStudent;

